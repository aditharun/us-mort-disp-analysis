setwd("~/Documents/GitHub/us-mort-disp-analysis/")
library(tidyverse)
if (!dir.exists("results")){
dir.create("results")
}
ageadj_file <- "data/cause_of_death_aamr.txt" %>% read_delim(., delim='\t') %>% slice(1:(1675-91))
#overall ageadj
net_excess_ageadj <- "data/excess_aamr_by_year.csv" %>% read_csv()
ageadj <- ageadj_file %>% select(Year, `ICD-10 113 Cause List`, Race, Gender, Deaths, Population, `Age Adjusted Rate`) %>% magrittr::set_colnames(c("year", "icd", "race", "gender", "deaths", "population", "ageadjrate"))
#NA year is 2020
ageadj <- ageadj %>% mutate(year = ifelse(is.na(year), 2020, year))
ageadj <- ageadj %>% mutate(race = ifelse(race == "White", "white", "black"))
ageadj <- ageadj %>% group_by(year, icd, gender) %>% summarize(unadj_excess_num = deaths[race=="black"] - (population[race=="black"] * (deaths[race=="white"]/population[race=="black"])), ageadj_excess = ageadjrate[race=="black"] - ageadjrate[race=="white"]) %>% ungroup()
icd_map <- ageadj %>% select(icd) %>% distinct() %>% mutate(name=c("Accidents", "Alzheimer's", "Assault", "Cerebrovascular Diseases", "Perinatal Period Conditions", "Chronic Liver Disease and Cirrhosis", "Chronic Lower Respiratory Diseases", "Diabetes", "Heart Disease", "Hypertension", "HIV", "Influenza and Pneumonia", "Suicide", "Cancer", "Nephritis", "Parkinson's", "Pneumonitis due to Solids/Liquids", "Septicemia"))
#top causes of death ageadj
ageadj <- ageadj %>% left_join(icd_map, by=c("icd"="icd")) %>% select(-icd)
######### PLOTTING and ANALYSIS #######################
overall_ageadj_changes <- net_excess_ageadj %>% group_by(gender, year) %>% group_by(gender) %>% arrange(year) %>% mutate(pct_yoy_change_mag = ((abs(excess_deaths_rate - lag(excess_deaths_rate))) / abs(lag(excess_deaths_rate))) * 100, direction = sign(excess_deaths_rate - lag(excess_deaths_rate)), change = excess_deaths_rate - lag(excess_deaths_rate), pct_yoy_change = pct_yoy_change_mag * direction) %>% ungroup()
#overall change by year and excess deaths rate each year
overall_ageadj_changes %>% select(race, gender, year, excess_deaths_rate) %>% ggplot(aes(x=year, y=excess_deaths_rate, color=race)) + geom_line() + geom_point() + theme_minimal() + facet_wrap(~gender)
overall_ageadj_changes %>% select(race, gender, year, change) %>% ggplot(aes(x=year, y=change, color=race)) + geom_line() + geom_point() + theme_minimal() + facet_wrap(~gender)
overall_ageadj_changes %>% select(race, gender, year, change) %>% filter(gender == "Male") %>% mutate(color = ifelse(year <= 2011, "green", "blue")) %>% ggplot(aes(x = factor(year), y = change, fill = color)) + geom_bar(stat = "identity", show.legend = FALSE) + scale_fill_manual(values = c("green", "blue")) + scale_x_discrete(breaks = c(2000:2011, 2012:2020)) + theme_minimal() + labs(x = "Year", y = "Change")
#average change in overall excess AAMR
#for males 1999-2011:
overall_ageadj_changes %>% filter(gender == "Male") %>% filter(year <= 2011)  %>% pull(pct_yoy_change) %>% mean(na.rm=T) %>% round(.,2)
#for females 1999-2015:
overall_ageadj_changes %>% filter(gender == "Female") %>% filter(year <= 2015)  %>% pull(pct_yoy_change) %>% mean(na.rm=T) %>% round(.,2)
ageadj
ageadj %>% group_by(gender) %>% sumarize(m - mean(ageadj_excess))
ageadj %>% group_by(gender) %>% summarize(m - mean(ageadj_excess))
ageadj %>% group_by(gender) %>% summarize(m = mean(ageadj_excess))
overall_ageadj_changes
overall_ageadj_changes %>% group_by(gender) %>% summarize(m = mean(excess_deaths_rate))
overall_ageadj_changes %>% group_by(gender) %>% summarize(m = mean(excess_deaths_rate)) %>% pull(m)
overall_ageadj_changes %>% select(race, gender, year, excess_deaths_rate) %>% ggplot(aes(x=year, y=excess_deaths_rate, color=race)) + geom_line() + geom_point() + theme_minimal() + facet_wrap(~gender)
overall_ageadj_changes %>% select(race, gender, year, change) %>% ggplot(aes(x=year, y=change, color=race)) + geom_line() + geom_point() + theme_minimal() + facet_wrap(~gender)
overall_ageadj_changes %>% select(race, gender, year, change) %>% filter(gender == "Male") %>% mutate(color = ifelse(year <= 2011, "green", "blue")) %>% ggplot(aes(x = factor(year), y = change, fill = color)) + geom_bar(stat = "identity", show.legend = FALSE) + scale_fill_manual(values = c("green", "blue")) + scale_x_discrete(breaks = c(2000:2011, 2012:2020)) + theme_minimal() + labs(x = "Year", y = "Change")
#average change in overall excess AAMR
#for males 1999-2011:
overall_ageadj_changes %>% filter(gender == "Male") %>% filter(year <= 2011)  %>% pull(pct_yoy_change) %>% mean(na.rm=T) %>% round(.,2)
#for females 1999-2015:
overall_ageadj_changes %>% filter(gender == "Female") %>% filter(year <= 2015)  %>% pull(pct_yoy_change) %>% mean(na.rm=T) %>% round(.,2)
#what pct of ageadj deaths excess are captured in the top causes of death yoy
pct_deaths <- rbind(ageadj, data.frame(year = c(2020, 2020), gender = c("Male", "Female"), unadj_excess_num = c(NA, NA), ageadj_excess = c(79.6, 47), name = c("COVID", "COVID"))) %>% group_by(year, gender) %>% summarize(net = sum(ageadj_excess)) %>% ungroup() %>% left_join(net_excess_ageadj, by=c("gender"="gender", "year"="year")) %>% mutate(pct_captured = round((net*100) / excess_deaths_rate))
pct_deaths
pct_deaths$pct_captured
pct_deaths$pct_captured %>% min()
pct_deaths$pct_captured %>% max
